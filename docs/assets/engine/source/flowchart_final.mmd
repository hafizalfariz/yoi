graph TD
    %% Theme
    classDef startup fill:#E8EAF6,stroke:#3949AB,stroke-width:2px,color:#1A237E;
    classDef input fill:#E1F5FE,stroke:#0288D1,stroke-width:2px,color:#01579B;
    classDef core fill:#E8F5E9,stroke:#388E3C,stroke-width:2px,color:#1B5E20;
    classDef insight fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px,color:#4A148C;
    classDef output fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#E65100;
    classDef control fill:#FBE9E7,stroke:#D84315,stroke-width:2px,color:#BF360C;

    %% 1) Startup
    subgraph S1["1. Startup and Config"]
        direction TB
        A([Start System]) --> B["Parse CLI and Register Signal Handler"]:::startup
        B --> C["Resolve Config Source<br/>Env or Default YAML"]:::startup
        C --> D["Init Video Reader<br/>File or RTSP"]:::input
    end

    %% 2) Core Runtime
    subgraph S2["2. Core Runtime Loop"]
        direction TB
        D --> E{"Next Frame Available"}:::core
        E -- Yes --> F["YOLO Inference<br/>Ultralytics and ONNX Runtime"]:::core
        E -- No --> P
        F --> G["Object Tracking<br/>ByteTrack first, Centroid fallback, Optional ReID"]:::core
        G --> H["Feature Engine"]:::insight
    end

    %% 3) Feature Context
    subgraph S3["3. Feature Analytics"]
        direction TB
        H --> H1["Line Cross"]:::insight
        H --> H2["Region Crowd"]:::insight
        H --> H3["Dwell Time"]:::insight
        H1 --> I["Analytics Summary per Frame"]:::insight
        H2 --> I
        H3 --> I

        H1 --> X{"Crossing Event Detected"}:::control
        X -- Yes --> O["Line Cross Event Snapshot image data status"]:::output
        X -- No --> I
    end

    %% 4) Outputs
    subgraph S4["4. Outputs and Integration"]
        direction TB
        I --> J["Annotate Frame<br/>BBox ID Region Line Metrics"]:::output
        J --> K["Push RTSP via FFmpeg to MediaMTX"]:::output
        J --> L["Save Annotated Video MP4"]:::output
        J --> M["Export Data<br/>JSON CSV Processing Log"]:::output
        J --> N["Persist Alerts<br/>JSONL and JSON"]:::output
    end

    %% 5) Loop & Shutdown
    K --> Z["Consolidate Outputs"]:::control
    L --> Z
    M --> Z
    N --> Z
    O --> Z

    Z --> P{"Stop Requested or End of Video"}:::control
    P -- No --> E
    P -- Yes --> Q["Graceful Cleanup<br/>Close writer reader RTSP and final export"]:::control
    Q --> R([End System])

    %% Signal Interruption Path
    subgraph S5["Signal Interruption Path"]
        direction TB
        B --> S{"Signal Received"}:::control
        S --> T["request_stop and terminate child processes"]:::control
        T --> P
    end